<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Feedback Data Dashboard</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for better visibility */
        .scroll-container::-webkit-scrollbar {
            height: 8px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #a0aec0; /* Tailwind gray-400 */
            border-radius: 4px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background-color: #f7fafc; /* Tailwind gray-50 */
        }
        /* Custom Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the loading overlay */
        #loading-overlay {
            display: none; /* Initially hidden */
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            z-index: 10;
            align-items: center;
            justify-content: center;
        }

        /* --- NEW STYLES FOR EXPANSION FEATURE --- */
        .clickable-row {
            cursor: pointer;
        }

        /* Detail row is hidden by default */
        .detail-row {
            display: none;
            background-color: #f7fafc; /* Tailwind gray-50 */
        }
        /* Ensure table content wraps for the long text columns */
        #data-table-body td {
            white-space: normal;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 border-b pb-2">
            AI Feedback & Query Data
        </h1>
        <p class="text-gray-600 mb-8">
            Filter the project data below using the AI Model, Project Name, User Feedback, and User Query text search. **Click any row to expand and view the full text content.**
        </p>

        <!-- Filter Controls Container -->
        <div id="filter-controls" class="bg-white p-6 rounded-xl shadow-lg mb-8 grid grid-cols-1 md:grid-cols-4 gap-4">

            <!-- Filter 1: AI Model (Dropdown) -->
            <div class="col-span-1">
                <label for="ai_model_filter" class="block text-sm font-medium text-gray-700 mb-1">AI Model</label>
                <select id="ai_model_filter"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white transition duration-150"
                        data-filter-param="ai_model">
                    <option value="All">All Models</option>
                    {% for model in ai_models %}
                        <option value="{{ model }}">{{ model }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filter 2: Project Name (Dropdown) -->
            <div class="col-span-1">
                <label for="project_name_filter" class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                <select id="project_name_filter"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white transition duration-150"
                        data-filter-param="project_name">
                    <option value="All">All Projects</option>
                    {% for project in project_names %}
                        <option value="{{ project }}">{{ project }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filter 3: Thumbs (Selection) -->
            <div class="col-span-1">
                <label for="thumbs_filter" class="block text-sm font-medium text-gray-700 mb-1">Feedback (Thumbs)</label>
                <select id="thumbs_filter"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white transition duration-150"
                        data-filter-param="thumbs">
                    <option value="All">All Feedback</option>
                    <option value="Up">üëç Up</option>
                    <option value="Down">üëé Down</option>
                </select>
            </div>

            <!-- Filter 4: User Query (Text Search) -->
            <div class="col-span-1">
                <label for="user_query_filter" class="block text-sm font-medium text-gray-700 mb-1">User Query (Search)</label>
                <input type="text" id="user_query_filter" placeholder="e.g., summarize, password, code"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                       data-filter-param="user_query" autocomplete="off">
            </div>

        </div>

        <!-- Result Summary -->
        <div class="mb-4 text-sm font-semibold text-gray-700">
            <span id="result-count" class="text-blue-600">Loading...</span> records found.
        </div>

        <!-- Data Table Container -->
        <div class="relative bg-white rounded-xl shadow-lg overflow-x-auto scroll-container">
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="absolute inset-0 flex items-center justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            </div>

            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0 z-5">
                    <tr id="table-header">
                        <!-- Table headers will be injected here -->
                    </tr>
                </thead>
                <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Data rows will be injected here -->
                </tbody>
            </table>

            <!-- Empty State Message -->
            <div id="empty-state" class="hidden text-center py-10 text-gray-500">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1-2 2v10a2 2 0 002 2h14a2 2 0 002-2V4a2 2 0 00-2-2H4a2 2 0 00-2 2v9zm16 0V4"></path></svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No results found</h3>
                <p class="mt-1 text-sm text-gray-500">
                    Try adjusting your filters.
                </p>
            </div>
        </div>

    </div>

    <script>
        // --- 1. DOM REFERENCES & STATE ---
        const tableBody = document.getElementById('data-table-body');
        const tableHeader = document.getElementById('table-header');
        const resultCountSpan = document.getElementById('result-count');
        const filterControls = document.getElementById('filter-controls');
        const loadingOverlay = document.getElementById('loading-overlay');
        const emptyState = document.getElementById('empty-state');

        let debounceTimer;

        // --- 2. RENDERING LOGIC ---

        // Function to toggle the visibility of the detail row
        function toggleDetail(rowKey) {
            const detailRow = document.getElementById(`detail-row-${rowKey}`);
            const mainRow = document.querySelector(`tr[data-row-key="${rowKey}"]`);

            if (detailRow.style.display === 'none' || detailRow.style.display === '') {
                detailRow.style.display = 'table-row';
                mainRow.classList.add('bg-blue-100'); // Highlight main row when open
            } else {
                detailRow.style.display = 'none';
                mainRow.classList.remove('bg-blue-100'); // Remove highlight when closed
            }
        }

        function formatValue(key, value) {
            // Apply specific formatting for the 'Thumbs' column
            if (key === 'Thumbs') {
                if (value === 'Up') return 'üëç Up';
                if (value === 'Down') return 'üëé Down';
            }
            // truncate the text
            if(typeof value == 'string' && value.length > 50){
                return value.substring(0, 50) + '...';
            }

            return value;
        }

        function renderTable(data, columns) {
            // Clear previous content
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            emptyState.classList.add('hidden');

            // Update result count
            resultCountSpan.textContent = data.length;

            if (data.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            // Render Header
            columns.forEach(col => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]';
                // Convert 'User_Query' to 'User Query' etc.
                th.textContent = col.replace(/([A-Z])/g, ' $1').trim();
                tableHeader.appendChild(th);
            });

            // Render Body Rows
            data.forEach(item => {
                const rowKey = item.RowKey;

                // --- 1. MAIN ROW (TRUNCATED VIEW) ---
                const row = document.createElement('tr');
                row.className = 'clickable-row hover:bg-blue-50 transition duration-150';
                row.setAttribute('data-row-key', rowKey);
                row.onclick = () => toggleDetail(rowKey); // Attach click handler

                columns.forEach(colKey => {
                    const cell = document.createElement('td');
                    cell.className = 'px-4 py-3 text-sm text-gray-900 border-b border-gray-100 align-top';

                    // Add truncation class only to the long text fields
                    if (colKey === 'User_Query' || colKey === 'User_Feedback' || colKey === 'AI_Response') {
                        cell.className += ' max-w-[300px]';
                    }

                    cell.textContent = formatValue(colKey, item[colKey]);
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);

                // --- 2. DETAIL ROW (EXPANDED FULL TEXT) ---
                const detailRow = document.createElement('tr');
                detailRow.id = `detail-row-${rowKey}`;
                detailRow.className = 'detail-row';

                const detailCell = document.createElement('td');
                // Span the detail row across all columns for full width
                detailCell.colSpan = columns.length;
                detailCell.className = 'px-6 py-4 text-xs text-gray-700 leading-relaxed border-b border-blue-200 shadow-inner';

                // Use innerHTML to inject structured full text content
                detailCell.innerHTML = `
                    <div class="space-y-4">
                        <p class="font-semibold text-sm text-gray-800 border-b pb-1">Expanded Details for RowKey: ${rowKey}</p>

                        <div class="bg-white p-3 border border-gray-200 rounded-lg">
                            <p class="font-medium text-gray-600 mb-1">User Query:</p>
                            <p class="text-gray-900 whitespace-pre-wrap">${item.User_Query}</p>
                        </div>

                        <div class="bg-white p-3 border border-gray-200 rounded-lg">
                            <p class="font-medium text-gray-600 mb-1">User Feedback:</p>
                            <p class="text-gray-900 whitespace-pre-wrap">${item.User_Feedback}</p>
                        </div>

                        <div class="bg-white p-3 border border-gray-200 rounded-lg">
                            <p class="font-medium text-gray-600 mb-1">AI Response:</p>
                            <p class="text-gray-900 whitespace-pre-wrap">${item.AI_Response}</p>
                        </div>
                    </div>
                `;

                detailRow.appendChild(detailCell);
                tableBody.appendChild(detailRow);

            });
        }


        // --- 3. DATA FETCHING & FILTERING ---

        async function fetchData() {
            // 1. Collect filter parameters from inputs
            const filters = {};
            const inputs = filterControls.querySelectorAll('[data-filter-param]');

            inputs.forEach(input => {
                const param = input.getAttribute('data-filter-param');
                const value = input.value.trim();
                // ONLY add filter if value exists AND it's not the default "All" option
                if (value && value !== 'All') {
                    filters[param] = value;
                }
            });

            // Build query string
            const queryString = new URLSearchParams(filters).toString();
            const apiUrl = `/api/data?${queryString}`;

            // Show loading state
            loadingOverlay.style.display = 'flex';

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    // This handles 404 or 500 responses gracefully
                    throw new Error(`HTTP error! status: ${response.status} from ${apiUrl}`);
                }

                // Try parsing the JSON
                const result = await response.json();

                // Render the new data
                renderTable(result.data, result.columns);

            } catch (error) {
                // Log the error to the console for debugging
                console.error('Error fetching or processing data. Check server terminal for details:', error);

                // Determine how many columns we need for the error message
                const headerCells = document.getElementById('table-header').cells.length || 8;

                // Display error message in the table area
                tableBody.innerHTML = `<tr><td colspan="${headerCells}" class="text-center py-6 text-red-500 font-semibold">
                    Error loading data. Check your Flask terminal for details.
                </td></tr>`;
                resultCountSpan.textContent = '0';
            } finally {
                // HIDE loading state (Crucial step that must always execute)
                loadingOverlay.style.display = 'none';
            }
        }

        // --- 4. EVENT LISTENERS ---

        function handleFilterChange() {
            // Clear any existing timer
            clearTimeout(debounceTimer);

            // Set a new timer to fetch data after a short delay (300ms)
            debounceTimer = setTimeout(() => {
                fetchData();
            }, 300);
        }

        // Attach event listeners to all filter controls
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = filterControls.querySelectorAll('[data-filter-param]');
            inputs.forEach(input => {
                // 'input' event for text fields
                if (input.tagName === 'INPUT') {
                    input.addEventListener('input', handleFilterChange);
                }
                // 'change' event for select/dropdown fields
                else if (input.tagName === 'SELECT') {
                    input.addEventListener('change', handleFilterChange);
                }
            });

            // Initial data load when the page is ready
            fetchData();
        });

    </script>
</body>
</html>
